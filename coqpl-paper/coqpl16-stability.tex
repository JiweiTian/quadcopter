%-----------------------------------------------------------------------------
%
%               Template for sigplanconf LaTeX Class
%
% Name:         sigplanconf-template.tex
%
% Purpose:      A template for sigplanconf.cls, which is a LaTeX 2e class
%               file for SIGPLAN conference proceedings.
%
% Guide:        Refer to "Author's Guide to the ACM SIGPLAN Class,"
%               sigplanconf-guide.pdf
%
% Author:       Paul C. Anagnostopoulos
%               Windfall Software
%               978 371-2316
%               paul@windfall.com
%
% Created:      15 February 2005
%
%-----------------------------------------------------------------------------


\documentclass[preprint,nocopyrightspace]{sigplanconf}

% The following \documentclass options may be useful:

% preprint      Remove this option only once the paper is in final form.
% 10pt          To set in 10-point type instead of 9-point.
% 11pt          To set in 11-point type instead of 9-point.
% authoryear    To obtain author/year citation style instead of numeric.

\usepackage{amsmath}
\usepackage{latexsym}
\usepackage{listings}
\usepackage[usenames]{xcolor}
\usepackage{lstcoq}
\usepackage{tikz}
\usepackage{pgfplots}

\usetikzlibrary{calc,positioning,decorations.markings,backgrounds}

\begin{document}

\special{papersize=8.5in,11in}
\setlength{\pdfpageheight}{\paperheight}
\setlength{\pdfpagewidth}{\paperwidth}

\conferenceinfo{CONF 'yy}{Month d--d, 20yy, City, ST, Country}
\copyrightyear{20yy}
\copyrightdata{978-1-nnnn-nnnn-n/yy/mm}
\doi{nnnnnnn.nnnnnnn}

% Uncomment one of the following two, if you are not going for the
% traditional copyright transfer agreement.

%\exclusivelicense                % ACM gets exclusive license to publish,
                                  % you retain copyright

%\permissiontopublish             % ACM gets nonexclusive license to publish
                                  % (paid open-access papers,
                                  % short abstracts)

\titlebanner{}        % These are ignored unless
\preprintfooter{}   % 'preprint' option specified.

\title{Formal Verification of Stability Properties of Cyber-physical Systems}
%% \subtitle{Subtitle Text, if any}

\authorinfo{Matthew Chan, Daniel Ricketts, Sorin Lerner, Gregory Malecha}
           {University of California, San Diego}
           {mattchan@ucsd.edu, daricket@cs.ucsd.edu, lerner@cs.ucsd.edu, gmalecha@eng.ucsd.edu}

\maketitle


% \category{CR-number}{subcategory}{third-level}

% % general terms are not compulsory anymore,
% % you may leave them out
% \terms
% term1, term2

% \keywords
% keyword1, keyword2

% intro, overview of project, overview of control theory, sketch of proof,
% future work
\section{Introduction}          % 1 col

We increasingly rely on computers to interact with the physical world for us.
At the large end, software underlies the control systems of commercial aircraft and power plants, and at the small end it controls medical devices and hobbiest UAVs.
The failure of any of these systems can have severe consequences which are often measured in the loss of human lives.
Formal verification has proven a promising approach to achieving very strong guarantees in more classic areas of computer science.
In this work we present an overview of our experiences formalizing stability properties of hybrid systems using the Coq proof assistant.

%% As we grow increasingly reliant on software for control of critical infrastructure, so does our need for guarantees that such software is free of errors. Complete formal verification with a proof assistant is the best way to obtain extremely strong guarantees that software systems satisfy a specification; however this technique has only recently been extended to the domain of cyber-physical systems [cite: ROScoq, MEMOCODE]. % is this true? Maybe a bit more here?
% In this paper, we present an overview of and our experiences in formalizing and reasoning about the physical behavior of hybrid systems in Coq.

In particular, we describe and contrast two approaches for proving the stability of a controller for the linear, one-dimensional hybrid system depicted in Figure~\ref{fig:system-visualization}.
This system runs in a loop where the controller sets the velocity ($v$) of the system and then the position ($x$) evolves according to the differential equation $\dot{x} = v$ for at most $\Delta$ time while $v$ remains constant.
The goal of the controller is to move the system to a desired position, which, without loss of generality, we assume to be 0.
The controller is a P-controller, so-named because it sets the velocity to a value \emph{proportional} to the difference between the current position and the desired position.

\section{System Specification}
\label{sec:veridrone}

We build our development on top of the VeriDrone project~\cite{ricketts2015veridrone}, a formalization of cyber-physical systems in the Coq proof assistant.
VeriDrone expresses cyber-physical systems and their properties uniformly in a linear temporal logic.
System specification generally take the form of the following temporal logic formula:
\begin{coq}
Init /\ $\Box$ (Discr \/ World)
\end{coq}
The first conjunct \coqe{Init} is a predicate over the initial state of the system.
The second conjunct (\coqe{$\Box$(...)}) expresses the transitions of the system.
It specifies that all temporally adjacent states are related by either \coqe{Discr}, a discrete transition that is morally of type \coqe{State -> State -> Prop}, or \coqe{World}, a continuous transition of the physical world expressed with predicates over the state and the time-derivative of variables in the state.
We focus on a \emph{proportional controller} which is described by the following instantiation of \coqe{Discr} and \coqe{World} and visualized in Figure~\ref{fig:system-visualization}. %% , these two types of transitions can be specified with
\begin{coq}
Def Discr := v' = -x / $\Delta$ /\ T' $\leq$ $\Delta$ /\ t' = t /\ x' = x

Def World :=
 Cont (fun $\partial$ => $\partial$ x = v /\ $\partial$ v = 0 /\ $\partial$ t = 1 /\ $\partial$ T = -1 /\ T' > 0)
\end{coq}

In addition to the variables \coqe{x} and \coqe{v}, we need two additional variables to fully specify our system: \coqe{t}, tracks the current time of the system, and \coqe{T}, a stopwatch that is reset every time the P-controller runs.
In the definition of \coqe{Discr}, \coqe{v' = -x/$\Delta$} specifies the P controller, \coqe{T' $\leq$ $\Delta$} specifies the resetting of the stopwatch, and \coqe{t' = t /\ x' = x} specify that the continuous variables are unchanged.
In the definition of \coqe{World}, \coqe{$\partial$ x = v} specifies the differential equation $\dot{x} = v$, \coqe{$\partial$ v = 0} specifies that the velocity remains constant during continuous transitions, \coqe{$\partial$ t = 1} specifies that \coqe{t} tracks the current time, \coqe{$\partial$ T = 0} specifies that the stopwatch remains constant during continuous transitions, and \coqe{T' $\geq$ 0} specifies that the stop watch is not past expired.

\begin{figure}
\centering

\begin{tikzpicture}
\begin{axis}[height=0.6\linewidth,width=0.8\linewidth,
          xmin=-0.1,xmax=3,ymax=3,ymin=-0.5,
          axis lines=middle,
          xlabel=$t$,
          ylabel=$x$]
%% \addplot[red,thick]  {pow(e,-1*x)} ; %% node[above]{$x=e^{-\beta t}$};
%% \addplot[black,dotted,thick] {-0.5 * (x + ln(0.5)) + 0.5} ; %% node[pos=0.75,right]{\tiny$x=\ln 0.5 + 0.5$};
%% \addplot[black,dashed,thick] {-0.5 * (x - 0.2) + 0.5} ; %% node[below]{$x=\ln 0.5 + 0.5$};
%% \addplot[black,dotted] {0.5} node[above,pos=0.75] {\small $x=0.5$};
\addplot[mark=x,blue] coordinates {(0.1,2.5) (0.7,1) (1.2,0.5) (1.8,0.3) (2.8,0)} ;
\node[anchor=west] at (axis cs:0.65,2) {\small discrete transitions} ;
\draw[opacity=0.2,-latex] (axis cs:0.65,2) to (axis cs:0.15,2.5) ;
\draw[opacity=0.2,-latex] (axis cs:0.65,2) to (axis cs:0.7,1.05) ;

\node[anchor=south] at (axis cs:2,0.9) {\small continuous transitions} ;
\draw[opacity=0.2,-latex] (axis cs:2,0.9) to (axis cs:1.5,0.5) ;
\draw[opacity=0.2,-latex] (axis cs:2,0.9) to (axis cs:2.3,0.2) ;
\end{axis}
\end{tikzpicture}

%% \greg{Draw a figure representing the system}

%% \greg{Label discrete and continuous transitions}

%% \greg{Label the axes}


%% \scalebox{0.6}{\input{p_viz.tex}}

\caption{Visualizing the proportional controller.}
\label{fig:system-visualization}
\end{figure}


%% The Veridrone project aims to build cyber-physical systems that adhere to various safety policies, by proving that various formal specifications are obeyed in Coq. Our work is implemented in the domain of hobbyist unmanned aerial vehicles (drones), described in .... We have constructed shims for bounding velocity and height, and shown how to compose them in [cite]. In this paper, we present our experiences in formalizing and reasoning about stability properties of the quadcopter.

%In order to avoid formalizing the entirety of the existing control software, we simply guard the feedback loop by inserting verified shims between the existing software and the actuators.



% start with the proof goal then introduce stability, or stability -> different proofs of stability?

\section{Stability}

In this work we use the VeriDrone system to reason about ``stability'' in the control theory sense.
Stability is a classic property that captures a temporal notion of boundedness in terms of distance from a goal point.
We will focus on two notions of stability which are shown graphically in Figure~\ref{fig:stability}:


\begin{enumerate}
\item \textbf{Lyapunov stability} states that if the system starts within $\beta > 0$ from the goal, then it will stay within $\alpha$ of the goal point for all time.
In our temporal logic, \coqe{x} is Lyapunov stable if
\begin{coq}
Definition LyapunovStable ($x$ : Term) : Formula :=
  Forall $\alpha$ : R, $\alpha$ > 0 -> (* boundary *)
    Exists $\beta$ : R, $\beta$ > 0 /\ (* start *)
      (|$x$| < $\beta$) -> $\Box$(|$x$| < $\alpha$).
\end{coq}
Note that the universal quantification of the boundary implies that if the system starts arbitrarily close, then it will remain arbitrarily close.
However, the definition does not imply that the system converges.
For example, the system that stays a constant distance from the goal is Lyapunov stable.

%%\item \textbf{Asymptotic stability} states that the distance from the goal is bounded by a decreasing function of time.
%% Formally, this is expressed by the following definition:

\item \textbf{Exponential stability} is a refinement of stability that guarantees that the system converges to the goal exponentially fast.
The formal definition is the following:
\begin{coq}
Definition ExpStable (x : Term) : Formula :=
  Exists $\alpha$ : R, $\alpha$ > 0 /\ Exists $\beta$ : R, $\beta$ > 0 /\
  Exists $x_0$: R, $x$ = $x_0$ /\ Exists $t_0$ : R, $t_0$ = $\tau$ /\
     $\Box$(|$x$| $\leq$ ($\alpha$ * |$x_0$| * e^{-$\beta$ * ($\tau$ - $t_0$)}).
\end{coq}
The first line existentially quantifies both $\alpha$ and $\beta$, and the second line captures the initial configuration (time in $t_0$ and the value of $x$ in $x_0$).
In this definition $\tau$ is the global time which increases monotonically, i.e. we must prove that our system is confined by a single exponential regardless of the number of discrete and continuous transitions it takes.

\end{enumerate}

%% These definitions form a heirarchy of stability.
%% All asymptotically stable systems are Lyapunov stable, and all exponentially stable systems are asymptotically stable.

\begin{figure}
  \begin{minipage}{0.49\linewidth}
    \centering
  \resizebox{\linewidth}{!}{\input{asymp_viz.tex}}

  \vspace{-0.5cm}
  Lyapunov stability
  \end{minipage}
  \begin{minipage}{0.49\linewidth}
  \centering
  \resizebox{\linewidth}{!}{\input{exp_viz.tex}}

  \vspace{-0.5cm}
  Exponential stability
  \end{minipage}

  \caption{Visualzation for Lyapunov and exponential stability.}
  \label{fig:stability}
\end{figure}

\vspace{-0.4cm}
\section{Proving Stability Directly}
\label{sec:graphical}

We began by proving that our system is Lyapunov stable using basic temporal logic induction.
While cumbersome due to the heavy use of arithmetic, the proof is quite similar to those performed when verifying safety properties of monitors in the VeriDrone~\cite{ricketts2015veridrone} work.
The proof proceeds in two steps.
First, we assume that $x$ is positive and we prove that the value of $x$ does not increase over time and further, never becomes negative.
Then, by symmetry we can reuse this proof to justify the negative case by ``reflecting the proof over'' the time axis.

\paragraph{Exponential Stability}
We are currently in the process of proving the same controller exponentially stable.
The proof is more subtle because we need to justify that the rate at which the system approaches the goal is greater than the rate at which the exponential function approaches the goal, which itself is a function of the time since the start.
However, the controller is time-invariant, i.e. its output does not depend directly on time.
This requires us to relate the slope of the exponential directly to the current value of $x$.

Figure~\ref{fig:graphical-proof} provides a graphical sketch of the reasoning.
As with the Lyapunov stability proof, we can just consider positive values of $x$.
We will pick $\alpha = 1$ and $\beta = \frac{1}{\beta}$.
The choice of $\beta$ here is essential for this particular controller.
In particular, note that the velocity chosen by the controller $-\frac{x}{\delta}$ is exactly the slope of the exponential \emph{where it crosses the horizontal line through $x$}.
Therefore, the trajectory of the system is parallel to the tangent line.
Since the exponential is concave up it is always greater than its tangent line (a fact we proved in Coq).
Therefore, by transitivity our location is always below the exponential during continuous transitions.
We have completed this proof in Coq.

While this appears to be the crux of the proof, it is not complete.
In particular, it only handles the continuous transition.
In order to extend the proof to the hybrid system, we must extend the proof to address the discrete transitions which has been more difficult than we anticipated.
%% The central difficulty, as with many verification efforts, lies in the inductive hypothesis.
%% While a similar proof methodology to the Lyapunov stability proof should work, we have been focused on a separation of parameters.




%% Since this domain is naturally a visual one, our first approach to proving stability is inspired by informal graphical proofs of Lyapunov stability and exponential stability of the controller described in Section~\ref{sec:veridrone}.
%% Here, we focus on the proof of exponential stability.
%% The graphical proof of exponential stability is depicted in Figure~\ref{fig:graphical-proof}.

\begin{figure}
\centering
\begin{tikzpicture}
\begin{axis}[height=0.6\linewidth,width=0.8\linewidth,
          xmin=-0.5,xmax=3,ymax=1.5,ymin=-0.5,
          axis lines=middle,
          xlabel=$t$,
          ylabel=$x$]
\addplot[red,thick]  {pow(e,-1*x)} ; %% node[above]{$x=e^{-\beta t}$};
\addplot[black,dotted,thick] {-0.5 * (x + ln(0.5)) + 0.5} ; %% node[pos=0.75,right]{\tiny$x=\ln 0.5 + 0.5$};
\addplot[black,dashed,thick] {-0.5 * (x - 0.2) + 0.5} ; %% node[below]{$x=\ln 0.5 + 0.5$};
\addplot[black,dotted] {0.5} node[above,pos=0.75] {\small $x=0.5$};
\end{axis}
\node[anchor=west] at (1,3) {\small $x=e^{-\beta t}$} ;
\node[anchor=west] at (4.5,0.3) {\small tangent} ;
\node[anchor=east] at (3,0.3) {\small trajectory} ;
\end{tikzpicture}

\caption{Graphical ``proof'' of exponential stability.}
\label{fig:graphical-proof}
\end{figure}

%% An important safety property we would like guarantees about is that of \emph{stability}. Given deceleration $d$, will our quadcopter eventually come to a stop? Or, given initial velocity $v$, will the quadcopter reach a target coordinate $c$? How quickly can it reach the target?

%% In control theory, stability formalizes these properties about a given system. Formally, it aims to show whether a set of differential equations will converge to a fixed point over time given some initial conditions. The challenge with applying the standard techniques from control theory to the domain of hybrid systems is in reasoning about both discrete and continuous aspects

% Canonically, there are three tiers of stability ---



% We have proven Lyapunov and Exponential stability for our height controller, which bounds the deceleration behavior of the quadcopter.

% something about TLA, the Sys abstraction and differential induction

% 1. Lyapunov stability

% 2. Exponential stability

% Exponential stability states that the continuous dynamics of the system will force the quadcopter to land exponentially fast --- that is,

% starting at an initial state

%% In order to formalize this graphical proof in Coq, we ...

%% In the time interval between runs of the discrete controller, $t_0\leq t \leq t_0+\Delta$, the height of the system will decrease exponentially fast over multiple continuous transitions of the system, with its upper bound given by the function
%%  \[E(t)=x_0e^{-b(t-t_0)}\]
%% but this leaves us with the unpleasant work of having to reason over fractionals. In order to simplify our proofs, we instead assert a stronger property --- that the height is bounded by the tangent to $E$ at $t_0$, selected at the start of the continuous transitions:
%% \[T(t) = E'(t_0)(t-t_0)+x_0 = -bx_0(t-t_0)+x_0\]
%% which we can then compose into a proof of exponential stability by showing that
%% \[
%%   \frac
%%   {\begin{aligned}
%%       & \vdash \emph{Init} \land \Box \emph{World} \rightarrow \Box \emph{Safe} \\
%%       & \vdash \Box (T\leq E)
%%     \end{aligned}}
%%   {\vdash \emph{Init} \land \Box \emph{World} \rightarrow \Box \emph{ExpSafe}}
%% \]

% Exponential stability of height over time: $E(t)=x_0e^{-b(t-t_0)}$
% tangent to Exp: \[T(t) = E'(t_0)(t-t_0)+x_0 = -bx_0(t-t_0)+x_0\]


% Should this be folded into the narrative about the two stability proofs?
% Or should this describe the interesting parts of the proofs while the above
% describes the math? .... what really do I put here?

\section{Stability Proofs using Lyapunov Functions}
\label{sec:lyapunov-functions}

In addition to the visually appealing approach described in Section~\ref{sec:graphical}, we have also begun exploring the use of Lyapunov functions to prove stability. %% potential of proving stability using a standard approach from control theory: 
Lyapunov functions allow one to prove stability of a system using a notion of the energy of the system which decreases over time until it reaches an equilibrium.
More precisely, a Lyapunov function for a one-dimensional system with an equilibrium at 0 is a function $V : \mathcal{R} \rightarrow \mathcal{R}$ such that $V(0) = 0$, $V(x) > 0$ for $x \neq 0$, and satisfying some condition on the time-derivative $\dot{V(x)}$.
This condition on $\dot{V}(x)$ depends on the particular notion of stability one would like to prove.
For Lyapunov stability and exponential stability, the conditions are $\dot{V}(x) \leq 0$ and $\dot{V}(x) \leq \alpha V(x)$ for $\alpha < 0$, respectively.

For a purely continuous P controller, specified by the differential equation $\dot{x} = -x$, the function $V(x) = \frac{1}{2}x^2$ serves as a Lyapunov function satisfying all three conditions on the time-derivative and thus establishes both notions of stability.
To see this, note that $\dot{V(x)} = x\dot{x} = -x^2$.
Unfortunately, for our hybrid P-controller, the same computation gives us $\dot{V(x)} = x\dot{x} = x*v$.
However, we can prove that our P-controller is a refinement of the system in which $\dot{x} = \frac{-x}{\Delta - (t - T)}$.
In other words, the velocity is proportional to the distance from the equilibrium and inversely proportional to the time remaining before the controller must run again.
Using this abstraction, it is possible to establish all three conditions on the time derivative of $V$ and hence both notions of stability.
Thus far, we have only completed the Coq proof of Lyapunov stability of our P-controller using a Lyapunov function.

\vspace{-0.2cm}
\section {Discussion}
It is interesting to contrast the process of formalizing the graphically-inspired proofs with the proofs based on Lyapunov functions.
Though the graphically-inspired proofs appear to be more intuitive on paper, our current experience suggests that they are more challenging to formalize due to a lack of abstraction of time.
Lyapunov functions provide this abstraction and hence seem to provide an cleaner path to a fully formal proof.
However, the time-abstraction seems a bit tenuous when using Lyapunov functions for a hybrid system rather than a purely continuous one.
For example, our approach above implicitly relies on being able to completely solve the differential equations, something that is often best to avoid.
This is especially the case since differential equations are often not equations at all, but rather inequalities.
More investigation is necessary to determine how both of these approaches scale to more complex hybrid systems.

% \emph{Coq as a reasoning tool: } Following several unsuccessful attempts to extend the proof of Lyapunov stability for exponential stability, we discovered that contrary to the hierarchy of mathematical definitions, the context that the two proofs needed are different. Because of the weakness of Lyapunov stability, we were able to correctly formulate it assuming that the


% This uncovered an interesting property about the interactions between the discrete and continuous parts of hybrid systems --- that

%  Intuitively, Lyapunov stability is a property that holds true for \emph{all time}, while asymptotic and exponential stability converge, and can be thought of as a piecewise function that becomes constant after the stable point is reached. did not realize this

% forced us to reexamine our formalism
% ... pointed out gaps in our reasoning.


% \emph{Reasoning about real arithmetic, powers and floating point: }
% A significant challenge faced during our development of the proofs, especially the

%% \section{Future work}

Our initial work on stability has focused on a one-dimensional P-controller.
P-controllers are the first step on the path to PID (Proportional-Integral-Derivative) controllers, which will allow expressing more exciting behaviors such as oscillatory convergence to a goal.
While still relatively simple, PID controllers form the vast majority of controllers in practice.
%% , rather than limiting behavior to be monotonically increasing or decreasing towards the goal as it is in the current formulation.
Ideally, the construction of a verified PID controller would follow from a layered composition, allowing for the separate construction of the I and D controllers.
%% It might prove helpful to reformulate our mathematics using the standard method of Lyapunov functions from control theory, which in principle would allow for the different types of stability to be expressed in a uniform way. In the context of hybrid systems, however, Lyapunov's method might need to be extended to incorporate the discrete component.


% Logical extensions to this work would be to show the convergence of the system in the remaining two dimensions, so as to guarantee that we can accurately reach any point in three dimensional space. To this end, . Further refinements on the


% Have to figure out how our formalism maps to PID controller theory
% ... PID (Proportional-Integral-Derivative) controllers.
% - Proportional gain
% - Integral - accelerates movement towards stable point. accounts for both positive and neg errors
% - Derivative -

% - use lyapunov functions - continuous, not hybrid. need a formalism for hybrid systems
% - higher order PI and PID controllers
% - composing controllers





% \appendix
% \section{Appendix Title}

% This is the text of the appendix, if you need one.

% \acks

% Acknowledgments, if needed.

% We recommend abbrvnat bibliography style.

\bibliographystyle{plain}

% The bibliography should be embedded for final submission.

\begin{thebibliography}{}
\softraggedright
% ROScoq: http://www.cs.cornell.edu/~aa755/ROSCoq/
% Stability defns: Murray et al, "A mathematical introduction to robotic manipulation, ch4"
% http://www.cds.caltech.edu/~murray/courses/cds101/fa02/caltech/mls93-lyap.pdf
\bibitem{ricketts2015veridrone}
D. Ricketts, G. Malecha, M. Alvarez, V. Gowda, S. Lerner.
\newblock ``Towards Verification of Hybrid Systems in a Foundational Proof Assistant''.
\newblock In \emph{MEMOCODE '15} 2015.
\end{thebibliography}


\end{document}

%                       Revision History
%                       -------- -------
%  Date         Person  Ver.    Change
%  ----         ------  ----    ------

%  2013.06.29   TU      0.1--4  comments on permission/copyright notices

%%  LocalWords:  VeriDrone Lyapunov Coq PID
